<html>
  <body>
    <form>
      <fieldset>
      <label for="module">Can I require</label>
      <input type="text" name="module" placeholder="mongodb">?
      <input type="submit" >
      <div>
      	<h2></h2>Node version: <span class="node-version"></span></h2>
        <h2>Available modules</h2>
        <ul class="availables">
        </ul>
      </div>
      </fieldset>
    </form>
    <script src="https://code.jquery.com/jquery-2.1.3.min.js" type="text/javascript"></script>
    <script type="text/sandbox" id="myapp">
      return function(context, cb) {
          try {
            require.resolve(context.data.module);
            cb(null, 'yes');
          } catch(e) {
            cb(null, 'nope.');
          }
      }
    </script>
    <script type="text/sandbox" id="list">
      var fs = require('fs');
      var natives = Object.keys(process.binding("natives")).filter(function(nativeDep) {
		    return nativeDep[0] !== '_';
		  }).map(function(native) {
			  return {version: 'native', name: native};
		  });

      return function(cb) {
	      cb(null, {
		      node_version: process.version,
		      modules: fs.readdirSync(__dirname + '/node_modules')
		        .filter(function(dir) {
			        return dir[0] !== '.';
		        })
		        .map(function(dep) {
				      var depObj = JSON.parse(fs.readFileSync(__dirname + '/node_modules/' + dep + '/package.json'));
				      return {
					      name : depObj.name,
					      version: depObj.version
				      }
				    }).concat(natives)
          });
        };
    </script>
    <script type="text/javascript">
      var $form = $('form');

      $form.on('submit', function(e) {
        e.preventDefault();
        $('fieldset').attr('disabled', true);
        var module_name = document.getElementsByName('module')[0].value;
        $.ajax({
          url: 'https://webtask.it.auth0.com/api/run/wt-tehsis-gmail_com-1?module=' + module_name,
          method: 'POST',
          data: $('#myapp').text(),
          headers: {
            Authorization: 'Bearer eyJhbGciOiJIUzI1NiIsImtpZCI6IjIifQ.eyJqdGkiOiJkNDdkM2IzNGQyYjc0YTBkOWNjODA5ODc4ZDcxZDhjZCIsImlhdCI6MTQzMDAwMTg2MCwiY2EiOltdLCJkZCI6MSwidGVuIjoiL153dC10ZWhzaXMtZ21haWxfY29tLVswLTFdJC8ifQ.IUE2hx2O6lks1KpTrHpqFANPBqijr_uvWX_r-CcNj_E'
          },
          dataType: 'text',
          }).done(function (data) {
            alert(data);
          }).fail(function (xhr, status, error) {
            alert(error);
          }).always(function() {
            $('fieldset').attr('disabled', false);
          });
      });
    </script>
    <script type="text/javascript">
      $.ajax({
        url: 'https://webtask.it.auth0.com/api/run/wt-tehsis-gmail_com-1',
        method: 'POST',
        data: $('#list').text(),
        headers: {
          Authorization: 'Bearer eyJhbGciOiJIUzI1NiIsImtpZCI6IjIifQ.eyJqdGkiOiJkNDdkM2IzNGQyYjc0YTBkOWNjODA5ODc4ZDcxZDhjZCIsImlhdCI6MTQzMDAwMTg2MCwiY2EiOltdLCJkZCI6MSwidGVuIjoiL153dC10ZWhzaXMtZ21haWxfY29tLVswLTFdJC8ifQ.IUE2hx2O6lks1KpTrHpqFANPBqijr_uvWX_r-CcNj_E'
        },
        }).done(function (data) {
          $('.node-version').text(data.node_version);
          $('.availables').append(data.modules.map(function(package) {
            return $('<li>').text(package.name + (package.version === 'native'?' (native)': ' - ' + package.version));
          }));
        }).fail(function (xhr, status, error) {
          alert(error);
        });
    </script>
  </body>
</html>
